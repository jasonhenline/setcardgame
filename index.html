<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set Card Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Style for the modal's pointer/arrow */
      #modal-arrow {
        position: absolute;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
      }
      /* Custom transition for smoother appearance */
      .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      /* Ensure all card slots are clickable */
      .card-slot {
        cursor: pointer;
        transition: box-shadow 0.3s ease;
      }
      /* Highlight style for found sets */
      .highlight {
        box-shadow: 0 0 0 4px #3b82f6; /* Blue-500 */
        border-radius: 0.5rem;
      }
      .picker-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <!-- Main Game Container -->
    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-700">Set Game Board</h1>
        <p class="text-gray-500 mt-2">
          Click any slot to pick or change a card.
        </p>
        <!-- Controls -->
        <div
          id="controls"
          class="mt-6 flex justify-center items-center gap-4 flex-wrap"
        >
          <button
            id="add-row-btn"
            class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all"
          >
            Add Row
          </button>
          <button
            id="remove-row-btn"
            class="px-5 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition-all"
          >
            Remove Row
          </button>
          <button
            id="find-set-btn"
            class="px-5 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-all"
          >
            Find Set
          </button>
          <button
            id="fill-random-btn"
            class="px-5 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75 transition-all"
          >
            Fill Random
          </button>
        </div>
        <!-- Message Area -->
        <div id="message-area" class="mt-4 text-lg font-medium h-6"></div>
      </header>

      <!-- Card Grid -->
      <div id="card-grid" class="grid grid-cols-3 gap-4 max-w-3xl mx-auto">
        <!-- Card slots will be generated by JavaScript -->
      </div>
    </div>

    <!-- Card Picker Modal -->
    <div
      id="card-picker-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"
    >
      <div
        id="modal-content"
        class="relative bg-white rounded-xl shadow-2xl p-6 w-full max-w-md fade-in"
      >
        <!-- Modal Arrow -->
        <div id="modal-arrow" class="text-white"></div>

        <!-- Step-by-step picker -->
        <div id="picker-steps">
          <!-- Step 1: Shape -->
          <div id="step-shape" class="picker-step">
            <h3 class="text-lg font-semibold mb-4 text-center">
              1. Choose a Shape
            </h3>
            <div class="grid grid-cols-3 gap-4">
              <!-- Dynamic content will be injected here -->
            </div>
          </div>

          <!-- Step 2: Fill -->
          <div id="step-fill" class="picker-step hidden">
            <h3 class="text-lg font-semibold mb-4 text-center">
              2. Choose a Fill
            </h3>
            <div class="grid grid-cols-3 gap-4">
              <!-- Dynamic content will be injected here -->
            </div>
          </div>

          <!-- Step 3: Count -->
          <div id="step-count" class="picker-step hidden">
            <h3 class="text-lg font-semibold mb-4 text-center">
              3. Choose a Count
            </h3>
            <div class="grid grid-cols-3 gap-4">
              <!-- Dynamic content will be injected here -->
            </div>
          </div>

          <!-- Step 4: Color -->
          <div id="step-color" class="picker-step hidden">
            <h3 class="text-lg font-semibold mb-4 text-center">
              4. Choose a Color
            </h3>
            <div class="grid grid-cols-3 gap-4">
              <!-- Dynamic content will be injected here -->
            </div>
          </div>
        </div>
        <!-- Close button -->
        <button
          id="close-modal-btn"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-800"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const cardGrid = document.getElementById("card-grid");
        const modal = document.getElementById("card-picker-modal");
        const modalContent = document.getElementById("modal-content");
        const modalArrow = document.getElementById("modal-arrow");
        const pickerStepsContainer = document.getElementById("picker-steps");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const addRowBtn = document.getElementById("add-row-btn");
        const removeRowBtn = document.getElementById("remove-row-btn");
        const findSetBtn = document.getElementById("find-set-btn");
        const fillRandomBtn = document.getElementById("fill-random-btn");
        const messageArea = document.getElementById("message-area");

        const INITIAL_ROWS = 4;
        const COLS = 3;

        let activeSlot = null;
        let selectedCard = {};
        let foundSets = [];
        let currentSetIndex = -1;

        // --- SVG Generation ---
        const colors = {
          red: "#ef4444",
          green: "#22c55e",
          purple: "#8b5cf6",
          black: "#1f2937",
        };

        function generateCardSVG(card) {
          const { shape, fill, count, color } = card;
          const strokeColor = colors[color];
          let defs = "",
            fillStyle = "";
          if (fill === "solid") fillStyle = `fill="${strokeColor}"`;
          else if (fill === "open")
            fillStyle = `fill="none" stroke="${strokeColor}" stroke-width="3"`;
          else if (fill === "striped") {
            const patternId = `pattern-${color}-${Math.random()}`; // Unique ID
            defs = `<defs><pattern id="${patternId}" patternUnits="userSpaceOnUse" width="8" height="8"><path d="M-2,2 l4,-4 M0,8 l8,-8 M6,10 l4,-4" stroke="${strokeColor}" stroke-width="2" /></pattern></defs>`;
            fillStyle = `fill="url(#${patternId})" stroke="${strokeColor}" stroke-width="3"`;
          }
          const shapePaths = {
            diamond: `<g transform="translate(25, 45) scale(0.60) translate(-25, -45)"><polygon points="25,0 50,45 25,90 0,45" /></g>`,
            oval: `<g transform="translate(25, 45) scale(0.60) translate(-25, -45)"><rect x="0" y="0" width="50" height="90" rx="25" /></g>`,
            squiggle: `<g transform="translate(25, 45) rotate(90) scale(0.505) translate(-54.5, -38.5)"><path d="M 104 15 C 112.4 36.9, 89.7 60.8, 63 54 C 52.3 51.3, 42.2 42, 27 53 C 9.6 65.6, 5.4 58.3, 5 40 C 4.6 22, 19.1 9.7, 36 12 C 59.2 15.2, 61.9 31.5, 89 14 C 95.3 10, 100.9 6.9, 104 15 Z" /></g>`,
          };
          let shapesToRender = "";
          const positions = { 1: [50], 2: [25, 75], 3: [15, 50, 85] };
          positions[count].forEach((xOffset) => {
            shapesToRender += `<g transform="translate(${xOffset}, 5)">${shapePaths[shape]}</g>`;
          });
          return `<svg viewBox="0 0 150 100" xmlns="http://www.w3.org/2000/svg" class="w-full h-full object-contain">${defs}<g ${fillStyle}>${shapesToRender}</g></svg>`;
        }

        // --- Game Logic ---
        function isPropertySet(a, b, c) {
          return (a === b && b === c) || (a !== b && a !== c && b !== c);
        }
        function isSet(c1, c2, c3) {
          return (
            isPropertySet(c1.color, c2.color, c3.color) &&
            isPropertySet(c1.shape, c2.shape, c3.shape) &&
            isPropertySet(c1.fill, c2.fill, c3.fill) &&
            isPropertySet(c1.count, c2.count, c3.count)
          );
        }

        /**
         * Resets the found sets state. Called whenever the board changes.
         */
        function resetFoundSetsState() {
          foundSets = [];
          currentSetIndex = -1;
          clearHighlights();
          showMessage("", "");
        }

        /**
         * Finds all sets on the board, then cycles through highlighting them on each call.
         */
        function cycleThroughSets() {
          clearHighlights();

          // If we haven't searched for sets yet (or if the board has changed), find them all.
          if (foundSets.length === 0 && currentSetIndex === -1) {
            const filledSlots = Array.from(
              document.querySelectorAll(".filled-card")
            );
            const cards = filledSlots.map((slot) => ({
              ...JSON.parse(slot.dataset.card),
              element: slot,
            }));

            if (cards.length < 3) {
              showMessage("Not enough cards to form a set.", "text-red-500");
              return;
            }

            // Find ALL sets and store them
            for (let i = 0; i < cards.length; i++) {
              for (let j = i + 1; j < cards.length; j++) {
                for (let k = j + 1; k < cards.length; k++) {
                  if (isSet(cards[i], cards[j], cards[k])) {
                    foundSets.push([
                      cards[i].element,
                      cards[j].element,
                      cards[k].element,
                    ]);
                  }
                }
              }
            }
          }

          // Now, cycle through the found sets
          if (foundSets.length > 0) {
            currentSetIndex = (currentSetIndex + 1) % foundSets.length;
            const setToHighlight = foundSets[currentSetIndex];
            setToHighlight.forEach((el) => el.classList.add("highlight"));
            showMessage(
              `Showing set ${currentSetIndex + 1} of ${foundSets.length}`,
              "text-green-500"
            );
          } else {
            // This handles the case where the initial search found nothing.
            showMessage("No sets present on the board.", "text-yellow-600");
            currentSetIndex = -1; // Allows re-searching if board doesn't change
          }
        }

        function clearHighlights() {
          document
            .querySelectorAll(".highlight")
            .forEach((el) => el.classList.remove("highlight"));
        }
        function showMessage(text, colorClass) {
          messageArea.textContent = text;
          messageArea.className = `mt-4 text-lg font-medium h-6 ${colorClass}`;
        }

        // --- Deck and Randomization ---
        function generateDeck() {
          const deck = [];
          const properties = {
            shapes: ["diamond", "squiggle", "oval"],
            fills: ["solid", "striped", "open"],
            counts: ["1", "2", "3"],
            colors: ["red", "green", "purple"],
          };
          for (const shape of properties.shapes)
            for (const fill of properties.fills)
              for (const count of properties.counts)
                for (const color of properties.colors)
                  deck.push({ shape, fill, count, color });
          return deck;
        }
        function shuffle(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }
        function fillBoardRandomly() {
          resetFoundSetsState();
          const deck = generateDeck();
          shuffle(deck);
          const slots = cardGrid.children;
          for (let i = 0; i < slots.length; i++) {
            const slot = slots[i];
            const cardData = deck.pop();
            if (cardData) {
              slot.dataset.card = JSON.stringify(cardData);
              slot.innerHTML = generateCardSVG(cardData);
              slot.className =
                "card-slot filled-card aspect-[3/2] bg-white rounded-lg transition-all duration-200";
            }
          }
        }

        // --- Grid Management ---
        function createEmptyCardSlot(index) {
          const cardSlot = document.createElement("div");
          cardSlot.className =
            "card-slot empty-card aspect-[3/2] bg-white border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-all duration-200";
          cardSlot.dataset.index = index;
          cardSlot.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" /></svg>`;
          return cardSlot;
        }
        function addRow() {
          resetFoundSetsState();
          const currentCardCount = cardGrid.children.length;
          for (let i = 0; i < COLS; i++)
            cardGrid.appendChild(createEmptyCardSlot(currentCardCount + i));
        }
        function removeRow() {
          if (cardGrid.children.length > COLS) {
            resetFoundSetsState();
            for (let i = 0; i < COLS; i++) cardGrid.lastElementChild.remove();
          }
        }
        function initializeGrid() {
          cardGrid.innerHTML = "";
          for (let i = 0; i < INITIAL_ROWS; i++) addRow();
          resetFoundSetsState();
        }

        // --- Modal Logic ---
        function updatePickerUI(stepName) {
          const stepEl = document.getElementById(`step-${stepName}`);
          const container = stepEl.querySelector(".grid");
          container.innerHTML = "";
          const options = {
            shape: {
              values: ["diamond", "squiggle", "oval"],
              labels: ["Diamond", "Squiggle", "Oval"],
            },
            fill: {
              values: ["solid", "striped", "open"],
              labels: ["Solid", "Striped", "Open"],
            },
            count: { values: ["1", "2", "3"], labels: ["One", "Two", "Three"] },
            color: {
              values: ["red", "green", "purple"],
              labels: ["Red", "Green", "Purple"],
            },
          };
          options[stepName].values.forEach((value, index) => {
            let previewCard = { ...selectedCard };
            if (stepName === "shape")
              previewCard = {
                shape: value,
                fill: "open",
                count: "1",
                color: "black",
              };
            else if (stepName === "fill") {
              previewCard.fill = value;
              previewCard.count = "1";
              previewCard.color = "black";
            } else if (stepName === "count") {
              previewCard.count = value;
              previewCard.color = "black";
            } else if (stepName === "color") previewCard.color = value;
            const button = document.createElement("button");
            button.dataset.value = value;
            button.className =
              "picker-option p-2 border rounded-lg hover:bg-blue-100 hover:border-blue-400 transition";
            button.innerHTML = `<div class="h-16 w-full">${generateCardSVG(
              previewCard
            )}</div><span>${options[stepName].labels[index]}</span>`;
            container.appendChild(button);
          });
        }

        function showModal(slotElement) {
          activeSlot = slotElement;
          modal.style.display = "flex";
          resetPicker();
          const slotRect = slotElement.getBoundingClientRect();
          const modalRect = modalContent.getBoundingClientRect();
          let top = slotRect.top - modalRect.height - 20,
            left = slotRect.left + slotRect.width / 2 - modalRect.width / 2;
          if (top < 10) {
            top = slotRect.bottom + 20;
            modalArrow.style.top = "-20px";
            modalArrow.style.borderTop = "none";
            modalArrow.style.borderBottom = "10px solid white";
          } else {
            modalArrow.style.bottom = "-20px";
            modalArrow.style.borderBottom = "none";
            modalArrow.style.borderTop = "10px solid white";
          }
          left = Math.max(
            10,
            Math.min(left, window.innerWidth - modalRect.width - 10)
          );
          modalContent.style.top = `${top}px`;
          modalContent.style.left = `${left}px`;
          modalContent.style.position = "fixed";
          modalArrow.style.left = `${
            slotRect.left + slotRect.width / 2 - left - 10
          }px`;
        }

        function hideModal() {
          modal.style.display = "none";
          activeSlot = null;
        }

        function resetPicker() {
          selectedCard = {};
          updatePickerUI("shape");
          document
            .querySelectorAll(".picker-step")
            .forEach((step) => step.classList.add("hidden"));
          document.getElementById("step-shape").classList.remove("hidden");
        }

        function handlePick(step, value) {
          selectedCard[step] = value;
          const nextStepMap = {
            shape: "fill",
            fill: "count",
            count: "color",
            color: null,
          };
          const nextStep = nextStepMap[step];
          if (nextStep) {
            updatePickerUI(nextStep);
            document.getElementById(`step-${step}`).classList.add("hidden");
            document
              .getElementById(`step-${nextStep}`)
              .classList.remove("hidden");
          } else {
            finalizeCardSelection();
          }
        }

        function finalizeCardSelection() {
          if (!activeSlot) return;
          resetFoundSetsState();
          activeSlot.dataset.card = JSON.stringify(selectedCard);
          activeSlot.innerHTML = generateCardSVG(selectedCard);
          activeSlot.classList.remove(
            "empty-card",
            "border-dashed",
            "border-gray-300",
            "flex",
            "items-center",
            "justify-center"
          );
          activeSlot.classList.add("filled-card");
          hideModal();
        }

        // --- Event Listeners ---
        cardGrid.addEventListener("click", (e) => {
          if (e.target.closest(".card-slot"))
            showModal(e.target.closest(".card-slot"));
        });
        pickerStepsContainer.addEventListener("click", (e) => {
          const optionButton = e.target.closest(".picker-option");
          if (optionButton) {
            const stepEl = optionButton.closest(".picker-step");
            handlePick(stepEl.id.split("-")[1], optionButton.dataset.value);
          }
        });
        closeModalBtn.addEventListener("click", hideModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) hideModal();
        });
        addRowBtn.addEventListener("click", addRow);
        removeRowBtn.addEventListener("click", removeRow);
        findSetBtn.addEventListener("click", cycleThroughSets);
        fillRandomBtn.addEventListener("click", fillBoardRandomly);

        // --- Initial Call ---
        initializeGrid();
      });
    </script>
  </body>
</html>
